name: Host2Play Auto Renew (YOLO Improved)

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 */6 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  renew:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆéœ€è¦ä¸‹è½½ä¸¤ä¸ªæ¨¡å‹ï¼‰
    
    permissions:
      actions: write
    
    steps:
      - name: Free Disk Space
        run: |
          echo "æ¸…ç†å‰ç£ç›˜ç©ºé—´:"
          df -h
          
          echo "åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          
          echo "æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -h
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: huanzhiyi/some-atuo-renew  # æ‚¨çš„ç§æœ‰ä»“åº“
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          lfs: false
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl
      
      - name: Cache Playwright browsers
        uses: actions/cache@v3
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-chromium-v1
      
      - name: Cache VisionAI Classification Model
        uses: actions/cache@v3
        id: classification-model-cache
        with:
          path: tmp_rovodev_recaptcha_ia/recaptcha_classification_57k.onnx
          key: visionai-classification-model-v1
          restore-keys: |
            visionai-classification-model-
      
      - name: Cache Detection Model
        uses: actions/cache@v3
        id: detection-model-cache
        with:
          path: tmp_rovodev_recaptcha_ia/model.onnx
          key: detection-model-onnx-v1
          restore-keys: |
            detection-model-onnx-
      
      - name: Cache Camoufox browser
        uses: actions/cache@v3
        id: camoufox-cache
        with:
          path: .camoufox_cache
          key: camoufox-${{ runner.os }}-v1
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          
          # ä¼˜å…ˆä½¿ç”¨ requirements æ–‡ä»¶
          if [ -f requirements_playwright.txt ]; then
            echo "ğŸ“¦ ä» requirements_playwright.txt å®‰è£…ä¾èµ–..."
            pip install -r requirements_playwright.txt
          elif [ -f requirements.txt ]; then
            echo "ğŸ“¦ ä» requirements.txt å®‰è£…ä¾èµ–..."
            pip install -r requirements.txt
          else
            echo "ğŸ“¦ æ‰‹åŠ¨å®‰è£…æ ¸å¿ƒä¾èµ–..."
            # Playwright + Camoufox
            pip install --default-timeout=300 --retries 3 playwright camoufox browserforge requests --no-cache-dir
            # YOLO æ¨ç†ä¾èµ–
            pip install --default-timeout=300 --retries 3 ultralytics opencv-python-headless pillow numpy onnxruntime==1.20.0 --no-cache-dir
          fi
          
          # éªŒè¯ä¾èµ–å®‰è£…
          python -c "import camoufox; import browserforge; import ultralytics; import onnxruntime; print('âœ… ä¾èµ–å®‰è£…æˆåŠŸ')"
      
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ“¥ å®‰è£… Playwright Chromium..."
          playwright install chromium --with-deps

      - name: Install Playwright dependencies only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: |
          echo "ğŸ“¦ å®‰è£… Playwright ç³»ç»Ÿä¾èµ–..."
          playwright install-deps chromium
      
      - name: Download VisionAI Classification Model
        if: steps.classification-model-cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ” åˆ†ç±»æ¨¡å‹ç¼“å­˜æœªå‘½ä¸­ï¼Œå¼€å§‹ä¸‹è½½..."
          mkdir -p tmp_rovodev_recaptcha_ia
          
          echo "ğŸ“¥ ä¸‹è½½ VisionAI åˆ†ç±»æ¨¡å‹ (recaptcha_classification_57k.onnx)..."
          echo "æ¥æº: HuggingFace - DannyLuna/recaptcha-classification-57k"
          
          curl -L -o tmp_rovodev_recaptcha_ia/recaptcha_classification_57k.onnx \
            "https://huggingface.co/DannyLuna/recaptcha-classification-57k/resolve/main/recaptcha_classification_57k.onnx?download=true" \
            --connect-timeout 60 \
            --max-time 600 \
            --retry 3 \
            --retry-delay 5 && {
            
            FILE_SIZE=$(stat -c%s tmp_rovodev_recaptcha_ia/recaptcha_classification_57k.onnx 2>/dev/null || stat -f%z tmp_rovodev_recaptcha_ia/recaptcha_classification_57k.onnx)
            
            if [ $FILE_SIZE -gt 100000000 ]; then
              echo "âœ… åˆ†ç±»æ¨¡å‹ä¸‹è½½æˆåŠŸï¼"
              echo "   æ–‡ä»¶å¤§å°: $(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB"
            else
              echo "âŒ æ–‡ä»¶å¤§å°å¼‚å¸¸: $FILE_SIZE bytes"
              echo "â„¹ï¸ è„šæœ¬ä¼šåœ¨è¿è¡Œæ—¶é‡æ–°ä¸‹è½½"
              rm -f tmp_rovodev_recaptcha_ia/recaptcha_classification_57k.onnx
            fi
          } || {
            echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œä½†è„šæœ¬å†…ç½®äº†è‡ªåŠ¨ä¸‹è½½åŠŸèƒ½"
          }
      
      - name: Download Detection Model
        if: steps.detection-model-cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ” æ£€æµ‹æ¨¡å‹ç¼“å­˜æœªå‘½ä¸­ï¼Œå¼€å§‹ä¸‹è½½..."
          mkdir -p tmp_rovodev_recaptcha_ia
          
          echo "ğŸ“¥ ä¸‹è½½æ£€æµ‹æ¨¡å‹ (model.onnx)..."
          echo "æ¥æº: DannyLuna17/RecaptchaV2-IA-Solver"
          
          # æ–¹æ³•1: GitHub LFS media
          echo "ğŸ”„ å°è¯•æ–¹æ³• 1: GitHub LFS media..."
          curl -L -o tmp_rovodev_recaptcha_ia/model.onnx \
            "https://media.githubusercontent.com/media/DannyLuna17/RecaptchaV2-IA-Solver/main/model.onnx" \
            --connect-timeout 60 \
            --max-time 600 \
            --retry 3 && {
            
            FILE_SIZE=$(stat -c%s tmp_rovodev_recaptcha_ia/model.onnx 2>/dev/null || stat -f%z tmp_rovodev_recaptcha_ia/model.onnx)
            
            if [ $FILE_SIZE -gt 100000000 ]; then
              echo "âœ… æ£€æµ‹æ¨¡å‹ä¸‹è½½æˆåŠŸï¼"
              echo "   æ–‡ä»¶å¤§å°: $(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB"
              exit 0
            fi
          }
          
          # æ–¹æ³•2: GitHub raw
          echo "âš ï¸ æ–¹æ³• 1 å¤±è´¥ï¼Œå°è¯•æ–¹æ³• 2: GitHub raw..."
          rm -f tmp_rovodev_recaptcha_ia/model.onnx
          curl -L -o tmp_rovodev_recaptcha_ia/model.onnx \
            "https://github.com/DannyLuna17/RecaptchaV2-IA-Solver/raw/main/model.onnx" \
            --connect-timeout 60 \
            --max-time 600 \
            --retry 3 && {
            
            FILE_SIZE=$(stat -c%s tmp_rovodev_recaptcha_ia/model.onnx 2>/dev/null || stat -f%z tmp_rovodev_recaptcha_ia/model.onnx)
            
            if [ $FILE_SIZE -gt 100000000 ]; then
              echo "âœ… æ£€æµ‹æ¨¡å‹ä¸‹è½½æˆåŠŸï¼"
              echo "   æ–‡ä»¶å¤§å°: $(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB"
              exit 0
            fi
          }
          
          echo "âš ï¸ æ‰€æœ‰ä¸‹è½½æ–¹æ³•å‡å¤±è´¥ï¼Œä½†è„šæœ¬å†…ç½®äº†è‡ªåŠ¨ä¸‹è½½åŠŸèƒ½"
      
      - name: Verify Models
        run: |
          echo "ğŸ” éªŒè¯æ¨¡å‹æ–‡ä»¶..."
          echo ""
          
          # éªŒè¯åˆ†ç±»æ¨¡å‹
          if [ -f tmp_rovodev_recaptcha_ia/recaptcha_classification_57k.onnx ]; then
            FILE_SIZE=$(stat -c%s tmp_rovodev_recaptcha_ia/recaptcha_classification_57k.onnx 2>/dev/null || stat -f%z tmp_rovodev_recaptcha_ia/recaptcha_classification_57k.onnx)
            echo "ğŸ“Š åˆ†ç±»æ¨¡å‹ (recaptcha_classification_57k.onnx):"
            echo "   æ–‡ä»¶å¤§å°: $FILE_SIZE bytes ($(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB)"
            
            if [ $FILE_SIZE -lt 100000000 ]; then
              echo "   âš ï¸ è­¦å‘Š: æ–‡ä»¶å¤§å°å¼‚å¸¸ (åº”è¯¥ ~108 MB)"
            else
              echo "   âœ… éªŒè¯é€šè¿‡"
            fi
          else
            echo "ğŸ“Š åˆ†ç±»æ¨¡å‹: âŒ ä¸å­˜åœ¨ï¼ˆè„šæœ¬å°†è‡ªåŠ¨ä¸‹è½½ï¼‰"
          fi
          
          echo ""
          
          # éªŒè¯æ£€æµ‹æ¨¡å‹
          if [ -f tmp_rovodev_recaptcha_ia/model.onnx ]; then
            FILE_SIZE=$(stat -c%s tmp_rovodev_recaptcha_ia/model.onnx 2>/dev/null || stat -f%z tmp_rovodev_recaptcha_ia/model.onnx)
            echo "ğŸ“Š æ£€æµ‹æ¨¡å‹ (model.onnx):"
            echo "   æ–‡ä»¶å¤§å°: $FILE_SIZE bytes ($(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB)"
            
            if [ $FILE_SIZE -lt 100000000 ]; then
              echo "   âš ï¸ è­¦å‘Š: æ–‡ä»¶å¤§å°å¼‚å¸¸ (åº”è¯¥ ~260 MB)"
            else
              echo "   âœ… éªŒè¯é€šè¿‡"
            fi
          else
            echo "ğŸ“Š æ£€æµ‹æ¨¡å‹: âŒ ä¸å­˜åœ¨ï¼ˆè„šæœ¬å°†è‡ªåŠ¨ä¸‹è½½ï¼‰"
          fi
          
          echo ""
          echo "â„¹ï¸ æ³¨æ„: å³ä½¿æ¨¡å‹ä¸å­˜åœ¨ï¼Œè„šæœ¬ä¹Ÿä¼šè‡ªåŠ¨ä¸‹è½½"
      
      - name: Run improved auto renew script
        env:
          RENEW_URL: ${{ secrets.RENEW_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          CI: 'true'
          GITHUB_ACTIONS: 'true'
          KEEP_CAPTCHA_IMAGES: 'false'
          TZ: Asia/Shanghai
        run: |
          echo "ğŸš€ è¿è¡Œæ”¹è¿›ç‰ˆ YOLO ç»­æœŸè„šæœ¬..."
          echo "ğŸ“Š ç­–ç•¥: VisionAI åŒæ¨¡å‹ï¼ˆåˆ†ç±» + æ£€æµ‹ï¼‰"
          echo ""
          python host2play_auto_renew_yolo_improved.py
      
      - name: Upload success screenshot
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: renew-success-improved-${{ github.run_number }}
          path: host2play_renew_success.png
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Upload error screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: renew-error-improved-${{ github.run_number }}
          path: host2play_error*.png
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Upload debug screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots-improved-${{ github.run_number }}
          path: debug_*.png
          retention-days: 3
          if-no-files-found: ignore
      
      - name: æ¸…ç†å·¥ä½œæµè®°å½•
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          delete_workflow_pattern: ${{ github.workflow }}
          retain_days: 0
          keep_minimum_runs: 3
