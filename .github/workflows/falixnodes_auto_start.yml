name: Falixnodes Auto Start Server

on:
  # å…è®¸åœ¨ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # å®šæ—¶æ‰§è¡Œï¼ˆæ¯å¤© UTC 00:00ï¼‰
  schedule:
    - cron: '0 0 * * *'

jobs:
  falixnodes_start_job:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: write

    # è¶…æ—¶è®¾ç½®ï¼š15åˆ†é’Ÿï¼ˆåŒ…å« Cloudflare éªŒè¯å’Œå¹¿å‘Šç­‰å¾…æ—¶é—´ï¼‰
    timeout-minutes: 15

    steps:
      - name: Free Disk Space
        run: |
          echo "æ¸…ç†å‰ç£ç›˜ç©ºé—´:"
          df -h
          
          echo "åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          
          echo "æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -h

      - name: Checkout private script repository
        uses: actions/checkout@v4
        with:
          repository: huanzhiyi/some-atuo-renew  # ç§æœ‰ä»“åº“åœ°å€
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          lfs: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache Playwright browsers
        uses: actions/cache@v3
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-firefox-${{ hashFiles('requirements_playwright.txt') }}
          restore-keys: |
            playwright-${{ runner.os }}-firefox-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          
          # å®‰è£…ä¾èµ–
          if [ -f requirements_playwright.txt ]; then
            pip install -r requirements_playwright.txt --default-timeout=300 --retries 3
          else
            pip install playwright camoufox[geoip] browserforge --default-timeout=300 --retries 3
          fi

      - name: Install Playwright browsers
        run: |
          # å®‰è£… Firefoxï¼ˆCamoufox åŸºäº Firefoxï¼‰
          playwright install firefox --with-deps

      - name: Run Falixnodes Auto Start Script
        env:
          FALIXNODES_SERVER_URLS: ${{ secrets.FALIXNODES_SERVER_URLS }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TZ: Asia/Shanghai
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œ Falixnodes è‡ªåŠ¨å¯åŠ¨è„šæœ¬..."
          python -u falixnodes_auto_start.py

      - name: Upload error artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots-${{ github.run_number }}
          path: "*.png"
          retention-days: 7
          if-no-files-found: ignore

      - name: Send Telegram Notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S %Z')
            
            if [ "${{ job.status }}" == "success" ]; then
              MESSAGE="âœ… Falixnodes æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ%0A%0AğŸ• æ‰§è¡Œæ—¶é—´: ${TIMESTAMP}%0AğŸ“Š è¿è¡Œç¼–å·: #${{ github.run_number }}%0AğŸ”— å·¥ä½œæµ: ${{ github.workflow }}"
            else
              MESSAGE="âŒ Falixnodes æœåŠ¡å™¨å¯åŠ¨å¤±è´¥%0A%0AğŸ• æ‰§è¡Œæ—¶é—´: ${TIMESTAMP}%0AğŸ“Š è¿è¡Œç¼–å·: #${{ github.run_number }}%0AğŸ”— å·¥ä½œæµ: ${{ github.workflow }}%0A%0Aè¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—"
            fi
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=HTML"
            
            echo "âœ… Telegram é€šçŸ¥å·²å‘é€"
          else
            echo "âš ï¸ æœªé…ç½® Telegramï¼Œè·³è¿‡é€šçŸ¥"
          fi

      - name: æ¸…ç†å·¥ä½œæµè®°å½•
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          delete_workflow_pattern: ${{ github.workflow }}
          retain_days: 0
          keep_minimum_runs: 3
