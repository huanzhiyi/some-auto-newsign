name: Host2Play Auto Renew (YOLO)

on:
  schedule:
    # æ¯å¤©è¿è¡Œä¸€æ¬¡ï¼ŒåŒ—äº¬æ—¶é—´ 10:00 (UTC 02:00)
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  renew:
    runs-on: ubuntu-latest
    
    steps:
      - name: Free Disk Space
        run: |
          echo "æ¸…ç†å‰ç£ç›˜ç©ºé—´:"
          df -h
          
          echo "åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          
          echo "æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -h
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies (minimal)
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
      
      - name: Cache Playwright browsers
        uses: actions/cache@v3
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-chromium
      
      - name: Cache YOLO model
        uses: actions/cache@v3
        id: yolo-model-cache
        with:
          path: model.onnx
          key: yolo-model-onnx-v1
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # Playwright + Camoufoxï¼ˆå¯è¿‡ Cloudflareï¼‰
          pip install --default-timeout=300 --retries 3 playwright camoufox browserforge requests --no-cache-dir
          # YOLO æ¨ç†ä¾èµ–ï¼ˆå›ºå®š onnxruntime ç‰ˆæœ¬é¿å…å…¼å®¹æ€§é—®é¢˜ï¼‰
          pip install --default-timeout=300 --retries 3 ultralytics opencv-python-headless pillow numpy onnxruntime==1.20.0 --no-cache-dir
          python -c "import camoufox; import browserforge; import ultralytics; import onnxruntime; print('deps ok')"
      
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          playwright install chromium --with-deps

      - name: Install Playwright dependencies only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: |
          playwright install-deps chromium
      
      - name: Download YOLO model
        if: steps.yolo-model-cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ” ç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦ä¸‹è½½ model.onnx..."
          
          # åˆ é™¤å¯èƒ½å­˜åœ¨çš„ LFS æŒ‡é’ˆæ–‡ä»¶
          rm -f model.onnx
          
          echo "ğŸ“¥ ä» DannyLuna17 çš„ fork ä»“åº“ä¸‹è½½ YOLO æ¨¡å‹..."
          
          # å°è¯•ä» GitHub LFS media ä¸‹è½½
          echo "ğŸ”„ å°è¯•æ–¹æ³• 1: GitHub LFS media é“¾æ¥..."
          curl -L -o model.onnx "https://media.githubusercontent.com/media/DannyLuna17/RecaptchaV2-IA-Solver/main/model.onnx" && {
            FILE_SIZE=$(stat -c%s model.onnx 2>/dev/null || stat -f%z model.onnx)
            if [ $FILE_SIZE -gt 1000000 ]; then
              echo "âœ… ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å¤§å°: $(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB"
              exit 0
            fi
          }
          
          echo "âš ï¸ æ–¹æ³• 1 å¤±è´¥ï¼Œå°è¯•æ–¹æ³• 2: ç›´æ¥ GitHub raw..."
          rm -f model.onnx
          curl -L -o model.onnx "https://github.com/DannyLuna17/RecaptchaV2-IA-Solver/raw/main/model.onnx" && {
            FILE_SIZE=$(stat -c%s model.onnx 2>/dev/null || stat -f%z model.onnx)
            if [ $FILE_SIZE -gt 1000000 ]; then
              echo "âœ… ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å¤§å°: $(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB"
              exit 0
            fi
          }
          
          echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹æ³•å‡å¤±è´¥ï¼Œä½†è„šæœ¬å†…ç½®äº†è‡ªåŠ¨ä¸‹è½½åŠŸèƒ½"
      
      - name: Verify YOLO model
        run: |
          echo "ğŸ” éªŒè¯ model.onnx æ–‡ä»¶..."
          
          if [ -f model.onnx ]; then
            FILE_SIZE=$(stat -c%s model.onnx 2>/dev/null || stat -f%z model.onnx)
            echo "ğŸ“¦ æ–‡ä»¶å¤§å°: $FILE_SIZE bytes ($(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB)"
            
            if [ $FILE_SIZE -lt 1000000 ]; then
              echo "âš ï¸ è­¦å‘Š: æ–‡ä»¶å¤§å°å¼‚å¸¸ï¼Œä½†è„šæœ¬ä¼šå°è¯•é‡æ–°ä¸‹è½½"
            else
              echo "âœ… æ¨¡å‹æ–‡ä»¶éªŒè¯é€šè¿‡"
            fi
          else
            echo "â„¹ï¸ æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè„šæœ¬å°†è‡ªåŠ¨ä¸‹è½½"
          fi
      
      - name: Run auto renew script
        env:
          RENEW_URL: ${{ secrets.RENEW_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          CI: 'true'
          KEEP_CAPTCHA_IMAGES: 'true'
        run: |
          python host2play_auto_renew_yolo.py
      
      - name: Upload success screenshot
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: renew-success-${{ github.run_number }}
          path: host2play_renew_success.png
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: renew-debug-${{ github.run_number }}
          path: |
            0.png
            host2play_*.png
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Upload error screenshot
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: renew-error-${{ github.run_number }}
          path: |
            host2play_error*.png
            host2play_*.png
            0.png
            1.png
            2.png
            3.png
            4.png
            5.png
            6.png
            7.png
            8.png
            9.png
            10.png
            11.png
            12.png
            13.png
            14.png
            15.png
            16.png
          retention-days: 7
          if-no-files-found: ignore
      
      - name: æ¸…ç†å·¥ä½œæµè®°å½•
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          delete_workflow_pattern: ${{ github.workflow }}
          retain_days: 0
          keep_minimum_runs: 3
