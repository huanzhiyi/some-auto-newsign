name: EC Servers Auto Renew

on:
  schedule:
    - cron: '0 0 * * *'
  
  # å…è®¸åœ¨ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  renew:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: read
      actions: write
    
    steps:
      - name: Free Disk Space
        run: |
          echo "æ¸…ç†å‰ç£ç›˜ç©ºé—´:"
          df -h
          
          echo "åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          
          echo "æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -h
      
      - name: Checkout private script repository
        uses: actions/checkout@v4
        with:
          repository: huanzhiyi/some-atuo-renew  # ç§æœ‰ä»“åº“åœ°å€
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          lfs: false
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache Camoufox browser
        uses: actions/cache@v3
        id: camoufox-cache
        with:
          path: |
            ~/.camoufox
            .camoufox_cache
          key: camoufox-${{ runner.os }}-v1
          restore-keys: |
            camoufox-${{ runner.os }}-
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          
          # å®‰è£… Playwright å’Œ Camoufox
          if [ -f requirements_playwright.txt ]; then
            pip install -r requirements_playwright.txt --default-timeout=300 --retries 3
          else
            pip install playwright camoufox --default-timeout=300 --retries 3
          fi
          
          echo "âœ… Python ä¾èµ–å®‰è£…å®Œæˆ"
      
      - name: Install Camoufox browser
        run: |
          python -m camoufox fetch
      
      - name: Run EC Servers Auto Renew Script
        env:
          ECSERVERS_EMAIL: ${{ secrets.ECSERVERS_EMAIL }}
          ECSERVERS_PASSWORD: ${{ secrets.ECSERVERS_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TZ: Asia/Shanghai
          GITHUB_ACTIONS: 'true'
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œ EC Servers è‡ªåŠ¨ç»­æœŸè„šæœ¬..."
          python -u ecservers_auto_renew.py
      
      - name: Upload success screenshot
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ecservers-success-${{ github.run_number }}
          path: |
            final_status.png
            no_servers.png
            *.png
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Upload error screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ecservers-error-${{ github.run_number }}
          path: |
            login_failed.png
            error_screenshot.png
            *.png
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Send Telegram Notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S %Z')
            
            if [ "${{ job.status }}" == "success" ]; then
              MESSAGE="âœ… EC Servers è‡ªåŠ¨ä¿æ´»æˆåŠŸ%0A%0AğŸ• æ‰§è¡Œæ—¶é—´: ${TIMESTAMP}%0AğŸ“Š è¿è¡Œç¼–å·: #${{ github.run_number }}%0AğŸ”— å·¥ä½œæµ: ${{ github.workflow }}%0A%0Aâœ¨ æœåŠ¡å™¨çŠ¶æ€å·²æ£€æŸ¥å¹¶ä¿æŒè¿è¡Œ"
            else
              MESSAGE="âŒ EC Servers è‡ªåŠ¨ä¿æ´»å¤±è´¥%0A%0AğŸ• æ‰§è¡Œæ—¶é—´: ${TIMESTAMP}%0AğŸ“Š è¿è¡Œç¼–å·: #${{ github.run_number }}%0AğŸ”— å·¥ä½œæµ: ${{ github.workflow }}%0A%0Aè¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—"
            fi
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=HTML"
            
            echo "âœ… Telegram é€šçŸ¥å·²å‘é€"
          else
            echo "âš ï¸ æœªé…ç½® Telegramï¼Œè·³è¿‡é€šçŸ¥"
          fi
      
      - name: æ¸…ç†å·¥ä½œæµè®°å½•
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          delete_workflow_pattern: ${{ github.workflow }}
          retain_days: 0
          keep_minimum_runs: 3

