name: Add Godlike Server Time

on:
  # å…è®¸åœ¨ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

  schedule:
    # æ¯å°æ—¶çš„ç¬¬20åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼ˆUTC æ—¶é—´ï¼‰
    # ä¾‹å¦‚ï¼š00:20, 01:20, 02:20, 03:20, ...
    - cron: '20 * * * *'

jobs:
  godlike_add_time_job:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: write
    # ç”±äºè„šæœ¬ç°åœ¨æ˜¯å•æ¬¡è¿è¡Œï¼Œä¸å†éœ€è¦é•¿æ—¶é—´çš„ timeout
    # è®¾ç½®ä¸€ä¸ªåˆç†çš„è¶…æ—¶ï¼Œä¾‹å¦‚10åˆ†é’Ÿï¼Œé˜²æ­¢æ„å¤–å¡æ­»
    timeout-minutes: 10

    steps:
      - name: Free Disk Space
        run: |
          echo "æ¸…ç†å‰ç£ç›˜ç©ºé—´:"
          df -h
          
          echo "åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          
          echo "æ¸…ç†åç£ç›˜ç©ºé—´:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache Playwright browsers
        uses: actions/cache@v3
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-chromium

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --default-timeout=300 --retries 3 playwright requests --no-cache-dir

      - name: Install Playwright browsers
        run: |
          playwright install chromium --with-deps

      - name: Run Time Adder Script
        env:
          SERVER_URL: ${{ secrets.SERVER_URL }}
          PTERODACTYL_COOKIE: ${{ secrets.PTERODACTYL_COOKIE }}
          PTERODACTYL_EMAIL: ${{ secrets.PTERODACTYL_EMAIL }}
          PTERODACTYL_PASSWORD: ${{ secrets.PTERODACTYL_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        # ä½¿ç”¨ -u å‚æ•°ç¦ç”¨è¾“å‡ºç¼“å†²ï¼Œç¡®ä¿æ—¥å¿—å®æ—¶æ˜¾ç¤º
        run: python -u godlike_auto_renew.py

      - name: Upload error artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots-${{ github.run_number }}
          path: "*.png"
          retention-days: 7
          if-no-files-found: ignore

      - name: Send Telegram Notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S UTC')
            
            if [ "${{ job.status }}" == "success" ]; then
              MESSAGE="âœ… Godlike æœåŠ¡å™¨ç»­æœŸæˆåŠŸ%0A%0AğŸ• æ‰§è¡Œæ—¶é—´: ${TIMESTAMP}%0AğŸ”— æœåŠ¡å™¨: ${{ secrets.SERVER_URL }}%0AğŸ“Š è¿è¡Œç¼–å·: #${{ github.run_number }}"
            else
              MESSAGE="âŒ Godlike æœåŠ¡å™¨ç»­æœŸå¤±è´¥%0A%0AğŸ• æ‰§è¡Œæ—¶é—´: ${TIMESTAMP}%0AğŸ”— æœåŠ¡å™¨: ${{ secrets.SERVER_URL }}%0AğŸ“Š è¿è¡Œç¼–å·: #${{ github.run_number }}%0A%0Aè¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—"
            fi
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=HTML"
            
            echo "âœ… Telegram é€šçŸ¥å·²å‘é€"
          else
            echo "âš ï¸ æœªé…ç½® Telegramï¼Œè·³è¿‡é€šçŸ¥"
          fi

      - name: æ¸…ç†å·¥ä½œæµè®°å½•
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          delete_workflow_pattern: ${{ github.workflow }}
          retain_days: 0
          keep_minimum_runs: 3
